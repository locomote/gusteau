#!/usr/bin/env ruby

require 'rubygems'
require 'optitron'

$LOAD_PATH << File.expand_path("../..", __FILE__)
require 'lib/gusteau'

class Gusteau::CLI < Optitron::CLI

  class_opt 'bootstrap', 'Install chef-solo'
  class_opt 'format',    'Output format to use', :short_name => 'F', :type => :string
  class_opt 'log_level', 'Set the log level',    :in => %w{debug info warn error fatal}
  class_opt 'why-run',   'Enable whyrun mode',   :short_name => 'W'

  desc 'Fully converge a node'
  def converge(node_name)
    node(node_name).converge(params)
  end

  desc 'Apply a run_list'
  def apply(node_name, run_list)
    node(node_name).apply(run_list.split(","), params)
  end

  desc 'SSH into a node'
  def ssh(node_name)
    node(node_name).ssh
  end

  desc 'Generate an SSH config'
  def ssh_config
    puts Gusteau::SSHConfig.new(nodes)
  end

  desc 'Generate an example project (a bureau)'
  def init(bureau_name)
    Gusteau::Bureau.new(bureau_name).generate!
  end

  desc 'Lists all known nodes'
  def list
    puts "Known nodes are:\n - #{nodes.keys.join("\n - ")}"
  end

  private

  def node(node_name)
    unless node = nodes[node_name]
      abort "Node '#{node_name}' is unknown. Known nodes are #{nodes.keys.join(', ')}."
    else
      node
    end
  end

  def nodes
    @nodes ||= Gusteau::Config.nodes(".gusteau.yml")
  end

end

Gusteau::CLI.dispatch
